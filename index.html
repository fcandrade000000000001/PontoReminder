<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ponto Reminder</title>
  <link rel="manifest" id="appManifest">
  <style>
    :root{--bg:#07101a;--card:#0f1724;--accent:#06d6a0;--muted:#9aa6b2}
    *{box-sizing:border-box;font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif}
    html,body{height:100%;margin:0;background:var(--bg);color:#e6eef6}
    .wrap{max-width:920px;margin:8px auto;padding:10px}
    header{display:flex;align-items:center;gap:10px}
    h1{margin:0;font-size:18px}
    .compact-row{display:flex;align-items:center;gap:8px}
    .card{background:var(--card);padding:10px;border-radius:10px;box-shadow:0 6px 18px rgba(2,6,23,.6)}
    button{background:transparent;border:1px solid rgba(255,255,255,.06);color:inherit;padding:8px 10px;border-radius:8px;cursor:pointer}
    button.primary{background:linear-gradient(90deg,var(--accent),#00b894);color:#02111a;border:0}
    .small{padding:6px 8px;font-size:13px}
    input,select,textarea{background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.06);color:inherit;padding:6px;border-radius:6px}
    .muted{color:var(--muted);font-size:13px}
    .row{display:flex;gap:8px;align-items:center}
    .spacer{flex:1}
    .history-list{max-height:180px;overflow:auto;margin-top:8px}
    @media(max-width:720px){ .wrap{padding:8px} .row{flex-direction:column;align-items:stretch} }
    #errorBox{background:#2b1010;color:#ffdede;padding:8px;border-radius:6px;margin:8px 0;display:none}
  </style>
</head>
<body>
  <div class="wrap" id="appWrap">
    <header>
      <div style="width:44px;height:44px;border-radius:8px;background:linear-gradient(135deg,#0ea5a4,#8b5cf6)"></div>
      <div style="flex:1">
        <h1>Ponto Reminder</h1>
        <div class="muted" id="dateNow">--</div>
      </div>
      <div>
        <div class="compact-row">
          <button id="btnEnableNotif" class="small" type="button">Notificações</button>
          <button id="btnInstall" class="small" type="button" style="display:none">Instalar</button>
        </div>
      </div>
    </header>

    <div id="errorBox">Erro: <span id="errorMsg"></span></div>

    <main style="margin-top:10px">
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div>
            <div class="muted">Entrada</div>
            <div style="display:flex;align-items:center;gap:8px">
              <div id="entradaDisplay" style="font-size:24px;font-weight:700">--:--</div>
              <button id="btnRemoveEntrada" class="small" type="button" title="Remover entrada" style="padding:4px 6px">Remover</button>
            </div>
          </div>
          <div style="text-align:right">
            <div class="muted">Saída recomendada</div>
            <div id="saidaRecomendada" style="font-size:24px;font-weight:700">--:--</div>
            <div id="timeRemaining" class="muted"></div>
          </div>
        </div>

        <div style="height:8px"></div>

        <div class="row" style="flex-wrap:wrap">
          <button id="btnEntrada" class="primary" type="button">Entrada</button>
          <button id="btnInicioAlm" type="button">Início Alm</button>
          <button id="btnFimAlm" type="button">Fim Alm</button>
          <button id="btnSaida" type="button">Saída</button>
          <button id="btnReset" type="button">Reset</button>
          <div class="spacer"></div>
          <button id="btnManual" class="small" type="button">Manual</button>
          <button id="btnTestTone" class="small" type="button">Testar toque</button>
        </div>

        <div style="margin-top:10px;display:flex;gap:8px;align-items:center;flex-wrap:wrap">
          <div>
            <div class="muted">Limite almoço (min)</div>
            <div class="row" style="margin-top:6px">
              <button id="btnLunchDec" class="small" type="button">-</button>
              <input id="cfgLunchLimit" type="number" min="15" step="5" value="120" style="width:80px" />
              <button id="btnLunchInc" class="small" type="button">+</button>
            </div>
          </div>

          <div>
            <div class="muted">Aviso antes da saída (min)</div>
            <input id="cfgLeaveWarn" type="number" min="1" value="15" style="width:80px" />
          </div>

          <div>
            <div class="muted">Toque</div>
            <select id="cfgTone" style="width:100px">
              <option value="01.mp3">01</option>
              <option value="02.mp3">02</option>
              <option value="03.mp3">03</option>
            </select>
          </div>

          <div>
            <div class="muted">Modo chato</div>
            <select id="cfgNag" style="width:100px">
              <option value="off">Off</option>
              <option value="on">On</option>
            </select>
          </div>

          <div>
            <div class="muted">Lembrete reunião</div>
            <div class="row" style="margin-top:6px"><input id="cfgMeeting" type="time" /><button id="btnAddMeeting" class="small" type="button">Salvar</button></div>
          </div>

        </div>

        <div id="lunchStatus" class="muted" style="margin-top:6px"></div>

        <div style="margin-top:10px;display:flex;gap:8px">
          <button id="btnSaveCfg" class="small" type="button">Salvar</button>
          <button id="btnResetCfg" class="small" type="button">Reset</button>
          <div class="spacer"></div>
        </div>

        <div style="margin-top:12px">
          <div class="muted">Histórico (hoje)</div>
          <div id="log" class="history-list"></div>
        </div>
      </div>

      <div class="card" style="margin-top:10px">
        <h3>Histórico — últimos 10 dias</h3>
        <div id="history" class="history-list"></div>
        <div style="margin-top:8px"><button id="btnClearStorage2" class="small" type="button">Limpar Storage</button></div>
      </div>

    </main>
  </div>

  <audio id="audioPlayer" preload="auto"></audio>

  <!-- Modal manual -->
  <div id="manualModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.5);align-items:center;justify-content:center;z-index:9999">
    <div style="background:var(--card);padding:14px;border-radius:10px;min-width:280px;max-width:95%;">
      <h3 style="margin:0 0 8px 0">Marcação manual</h3>
      <div style="display:flex;flex-direction:column;gap:8px">
        <label class="muted">Tipo</label>
        <select id="manualType" style="padding:8px;border-radius:6px">
          <option value="entrada">Entrada</option>
          <option value="inicioAlm">Início Almoço</option>
          <option value="fimAlm">Fim Almoço</option>
          <option value="saida">Saída</option>
        </select>

        <label class="muted">Hora (HH:MM) — deixe vazio para Agora</label>
        <input id="manualTime" type="time" style="padding:8px;border-radius:6px" />

        <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:6px">
          <button id="manualCancel" class="small" type="button">Cancelar</button>
          <button id="manualSave" class="small primary" type="button">Salvar</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', function(){
      try{
        var KEY = 'ponto.reminder.v1';
        var CFG_KEY = 'ponto.reminder.cfg.v1';
        var MAX_HISTORY_DAYS = 10;

        function todayKey(){ var d = new Date(); return d.toISOString().slice(0,10); }

        var defaults = { cfg: { lunchLimitMin:120, leaveWarnMin:15, tone:'01.mp3', nag:'off', meeting:'' } };

        function loadCfg(){ try{ var raw = localStorage.getItem(CFG_KEY); if(!raw) return Object.assign({}, defaults.cfg); var parsed = JSON.parse(raw); if(!parsed || typeof parsed !== 'object') return Object.assign({}, defaults.cfg); // merge missing
            return Object.assign({}, defaults.cfg, parsed);
          }catch(e){ console.warn('cfg load error', e); return Object.assign({}, defaults.cfg); } }

        function saveCfg(cfg){ try{ localStorage.setItem(CFG_KEY, JSON.stringify(cfg)); }catch(e){ console.warn('saveCfg failed', e); } }

        function loadAll(){
          try{
            var raw = localStorage.getItem(KEY);
            if(!raw) return { dates: {}, meta: {} };
            var parsed = JSON.parse(raw);
            if(!parsed || typeof parsed !== 'object') return { dates: {}, meta: {} };
            // ensure structure
            if(!parsed.dates || typeof parsed.dates !== 'object') parsed.dates = {};
            if(!parsed.meta || typeof parsed.meta !== 'object') parsed.meta = {};
            return parsed;
          }catch(e){
            console.warn('loadAll parse error', e);
            // attempt to back up corrupted value (best-effort)
            try{
              localStorage.setItem(KEY + '.corrupted.' + (new Date()).toISOString(), localStorage.getItem(KEY));
            }catch(nope){}
            // reset to safe structure
            return { dates: {}, meta: {} };
          }
        }

        function saveAll(obj){
          try{
            obj = obj || { dates: {}, meta: {} };
            // prune keys safely: take valid keys only (strings that look like yyyy-mm-dd)
            var allKeys = Object.keys(obj.dates || {}).filter(function(k){
              return typeof k === 'string' && /^[0-9]{4}-[0-9]{2}-[0-9]{2}$/.test(k);
            }).sort().reverse().slice(0, MAX_HISTORY_DAYS);
            var pruned = {};
            for(var i=0;i<allKeys.length;i++){ var kk = allKeys[i]; pruned[kk] = obj.dates[kk]; }
            obj.dates = pruned;
            obj.meta = obj.meta || {};
            obj.meta.savedAt = new Date().toISOString();
            localStorage.setItem(KEY, JSON.stringify(obj));
          }catch(e){ console.warn('saveAll failed', e); }
        }

        var storage = loadAll();
        var cfg = loadCfg();

        // ensure storage.dates exists as object
        if(!storage || typeof storage !== 'object') storage = { dates: {}, meta: {} };
        if(!storage.dates || typeof storage.dates !== 'object') storage.dates = {};

        function ensureToday(){
          try{
            var k = todayKey();
            if(!storage.dates[k] || typeof storage.dates[k] !== 'object'){
              storage.dates[k] = { entrada:null, inicioAlm:null, fimAlm:null, saida:null, history:[] };
              // we don't immediately prune old dates here, saveAll will prune when saving
              saveAll(storage);
            }
          }catch(e){ console.warn('ensureToday', e); }
        }

        function getStateFor(dateKey){
          try{
            if(!dateKey) return { entrada:null, inicioAlm:null, fimAlm:null, saida:null, history:[] };
            if(!storage.dates || typeof storage.dates !== 'object') storage.dates = {};
            var s = storage.dates[dateKey];
            if(!s || typeof s !== 'object'){
              // return an empty structure but do not mutate storage unless ensureToday called
              return { entrada:null, inicioAlm:null, fimAlm:null, saida:null, history:[] };
            }
            // ensure history array exists
            if(!Array.isArray(s.history)) s.history = [];
            return s;
          }catch(e){ console.warn('getStateFor', e); return { entrada:null, inicioAlm:null, fimAlm:null, saida:null, history:[] }; }
        }

        ensureToday();

        var audio = document.getElementById('audioPlayer');

        function setAudioSource(){ try{ if(!cfg || !cfg.tone) cfg = Object.assign({}, defaults.cfg, cfg || {}); audio.src = 'assets/ring/' + (cfg.tone || '01.mp3'); }catch(e){} }
        function playTone(){ try{ setAudioSource(); audio.loop = (cfg && cfg.nag === 'on'); audio.currentTime = 0; var p = audio.play(); if(p && typeof p.catch === 'function') p.catch(function(){/* autoplay blocked */}); }catch(e){} }
        function stopTone(){ try{ audio.pause(); audio.currentTime = 0; audio.loop = false; }catch(e){} }

        function notify(title, body){ try{ if('Notification' in window){ if(Notification.permission === 'granted'){ try{ new Notification(title, { body: body, requireInteraction: (cfg && cfg.nag === 'on') }); }catch(e){} } } if(navigator.vibrate) navigator.vibrate([200,100,200]); }catch(e){} }

        var byId = function(id){ return document.getElementById(id); };
        var entradaDisplay = byId('entradaDisplay');
        var saidaRecomendada = byId('saidaRecomendada');
        var timeRemaining = byId('timeRemaining');
        var logEl = byId('log');
        var historyEl = byId('history');

        function fmtTime(d){ if(!d) return '--:--'; try{ var dt = new Date(d); if(isNaN(dt.getTime())) return '--:--'; return dt.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}); }catch(e){ return '--:--'; } }
        function nowIso(){ return (new Date()).toISOString(); }

        function pushHistory(dateKey, evt){
          try{
            if(!dateKey) dateKey = todayKey();
            if(!storage.dates) storage.dates = {};
            if(!storage.dates[dateKey] || typeof storage.dates[dateKey] !== 'object') storage.dates[dateKey] = { entrada:null, inicioAlm:null, fimAlm:null, saida:null, history:[] };
            var s = storage.dates[dateKey];
            if(!Array.isArray(s.history)) s.history = [];
            s.history.unshift(evt);
            if(s.history.length > 300) s.history = s.history.slice(0,300);
            saveAll(storage);
            renderHistory();
          }catch(e){ console.warn('pushHistory', e); }
        }

        function clearFieldToday(fieldName){
          try{
            var k = todayKey();
            ensureToday();
            var s = getStateFor(k);
            if(!s) return;
            if(!s[fieldName]) { alert('Nada para remover em ' + fieldName); return; }
            if(!confirm('Remover ' + fieldName + ' do dia ' + k + '?')) return;
            // mutate the stored object safely
            if(!storage.dates[k] || typeof storage.dates[k] !== 'object') storage.dates[k] = { entrada:null, inicioAlm:null, fimAlm:null, saida:null, history:[] };
            storage.dates[k][fieldName] = null;
            pushHistory(k, { type: 'removed_' + fieldName, time: nowIso(), note: 'Removido manualmente' });
            saveAll(storage);
            render();
            scheduleAll();
          }catch(e){ reportError(e); }
        }

        function markEntrada(t){
          try{
            var k = todayKey(); ensureToday();
            var s = getStateFor(k);
            if(s && s.entrada){
              if(!confirm('Já existe uma entrada às ' + fmtTime(s.entrada) + '. Deseja sobrescrever?')) return;
            }
            if(!t) t = nowIso();
            if(!storage.dates[k] || typeof storage.dates[k] !== 'object') storage.dates[k] = { entrada:null, inicioAlm:null, fimAlm:null, saida:null, history:[] };
            storage.dates[k].entrada = t;
            pushHistory(k, { type:'entrada', time: t });
            saveAll(storage);
            render();
            scheduleAll();
          }catch(e){ reportError(e); }
        }

        function markInicioAlm(t){
          try{
            var k = todayKey(); ensureToday();
            var s = getStateFor(k);
            if(s && s.inicioAlm){
              if(!confirm('Já iniciou almoço às ' + fmtTime(s.inicioAlm) + '. Deseja sobrescrever?')) return;
            }
            if(!t) t = nowIso();
            if(!storage.dates[k] || typeof storage.dates[k] !== 'object') storage.dates[k] = { entrada:null, inicioAlm:null, fimAlm:null, saida:null, history:[] };
            storage.dates[k].inicioAlm = t;
            pushHistory(k, { type:'inicioAlm', time: t });
            saveAll(storage);
            render();
            scheduleAll();
          }catch(e){ reportError(e); }
        }

        function markFimAlm(t){
          try{
            var k = todayKey(); ensureToday();
            var s = getStateFor(k);
            if(s && s.fimAlm){
              if(!confirm('Já encerrou almoço às ' + fmtTime(s.fimAlm) + '. Deseja sobrescrever?')) return;
            }
            if(!t) t = nowIso();
            if(!storage.dates[k] || typeof storage.dates[k] !== 'object') storage.dates[k] = { entrada:null, inicioAlm:null, fimAlm:null, saida:null, history:[] };
            storage.dates[k].fimAlm = t;
            pushHistory(k, { type:'fimAlm', time: t });
            saveAll(storage);
            render();
            scheduleAll();
          }catch(e){ reportError(e); }
        }

        function markSaida(t){
          try{
            var k = todayKey(); ensureToday();
            var s = getStateFor(k);
            if(s && s.saida){
              if(!confirm('Já existe uma saída às ' + fmtTime(s.saida) + '. Deseja sobrescrever?')) return;
            }
            if(!t) t = nowIso();
            if(!storage.dates[k] || typeof storage.dates[k] !== 'object') storage.dates[k] = { entrada:null, inicioAlm:null, fimAlm:null, saida:null, history:[] };
            storage.dates[k].saida = t;
            pushHistory(k, { type:'saida', time: t });
            saveAll(storage);
            render();
            scheduleAll();
          }catch(e){ reportError(e); }
        }

        function resetDia(){ try{ if(!confirm('Confirma reset do dia?')) return; var k = todayKey(); storage.dates[k] = { entrada:null, inicioAlm:null, fimAlm:null, saida:null, history:[] }; saveAll(storage); render(); scheduleAll(); }catch(e){ reportError(e); } }

        function openManual(){ try{ var modal = byId('manualModal'); if(modal) modal.style.display = 'flex'; }catch(e){} }

        function getLunchDurationMsFor(dateKey){ try{ var s = getStateFor(dateKey); if(!s || !s.inicioAlm) return 0; var end = s.fimAlm ? new Date(s.fimAlm) : new Date(); var start = new Date(s.inicioAlm); if(isNaN(start.getTime())) return 0; return Math.max(0, end - start); }catch(e){ return 0; } }
        function calcRecommendedExitFor(dateKey){ try{ var s = getStateFor(dateKey); if(!s || !s.entrada) return null; var entrada = new Date(s.entrada); if(isNaN(entrada.getTime())) return null; var workMs = 8*60*60*1000; var lunchMs = 0; if(s.inicioAlm && s.fimAlm){ var a = new Date(s.inicioAlm), b = new Date(s.fimAlm); if(!isNaN(a.getTime()) && !isNaN(b.getTime())) lunchMs = b - a; } else if(s.inicioAlm && !s.fimAlm){ var a2 = new Date(s.inicioAlm); if(!isNaN(a2.getTime())) lunchMs = new Date() - a2; } var exit = new Date(entrada.getTime() + workMs + lunchMs); return exit; }catch(e){ return null; } }

        function scheduleAll(){ try{
          if(window._pontoTimers) { for(var i=0;i<window._pontoTimers.length;i++){ clearTimeout(window._pontoTimers[i]); } }
          window._pontoTimers = [];
          var k = todayKey();
          var exit = calcRecommendedExitFor(k);
          if(exit){
            var now = new Date();
            var delta = exit - now;
            if(delta > 0){
              var warnMs = (cfg && cfg.leaveWarnMin ? cfg.leaveWarnMin : 15) * 60 * 1000;
              var tWarn = delta - warnMs;
              if(tWarn > 0) window._pontoTimers.push(setTimeout(function(){ triggerLeaveWarning(exit); }, tWarn));
              window._pontoTimers.push(setTimeout(function(){ triggerLeaveWarning(exit, true); }, delta));
            }
          }
          var s = getStateFor(k);
          if(s && s.inicioAlm && !s.fimAlm){
            var start = new Date(s.inicioAlm);
            if(!isNaN(start.getTime())){
              var limit = start.getTime() + ((cfg && cfg.lunchLimitMin ? cfg.lunchLimitMin : 120) * 60 * 1000);
              var nowT = Date.now();
              var delta2 = limit - nowT;
              if(delta2 > 0) window._pontoTimers.push(setTimeout(function(){ triggerLunchLimit(); }, delta2));
              else triggerLunchLimit();
            }
          }
          if(cfg && cfg.meeting){
            var parts = (cfg.meeting || '').split(':');
            if(parts[0] !== undefined && parts[0] !== ''){
              var d = new Date();
              d.setHours(parseInt(parts[0],10), parseInt(parts[1]||0,10),0,0);
              var dd = d.getTime() - Date.now();
              if(dd > 0) window._pontoTimers.push(setTimeout(function(){ triggerMeetingReminder(cfg.meeting); }, dd));
            }
          }
        }catch(e){ console.warn('scheduleAll failed', e); } }

        function triggerLunchLimit(){ notify('Almoço: limite atingido', 'Você atingiu o limite configurado de almoço. Marque retorno.'); playTone(); }
        function triggerMeetingReminder(time){ notify('Lembrete: reunião', 'Reunião às ' + time); playTone(); }
        function triggerLeaveWarning(exit, force){ var t = new Date(exit); var msg = force ? ('Hora de sair (' + (t && t.toLocaleTimeString ? t.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'}) : '') + ')') : ('Faltam ' + (cfg && cfg.leaveWarnMin ? cfg.leaveWarnMin : 15) + ' minutos para sua saída às ' + (t && t.toLocaleTimeString ? t.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'}) : '')); notify('Saída', msg); playTone(); }

        function render(){
          try{
            var k = todayKey();
            ensureToday();
            var s = getStateFor(k);
            entradaDisplay.textContent = (s && s.entrada) ? fmtTime(s.entrada) : '--:--';
            var exit = calcRecommendedExitFor(k);
            saidaRecomendada.textContent = exit ? exit.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'}) : '--:--';

            if(exit){
              var diffMs = new Date(exit) - new Date();
              if(diffMs > 0){
                var mins = Math.ceil(diffMs/60000);
                timeRemaining.textContent = 'Faltam ' + mins + ' min';
              } else timeRemaining.textContent = 'Jornada concluída';
            } else timeRemaining.textContent = '';

            var lunchDiv = document.getElementById('lunchStatus');
            if(lunchDiv){
              if(s && s.inicioAlm && !s.fimAlm){
                var start = new Date(s.inicioAlm);
                if(!isNaN(start.getTime())){
                  var limitMs = start.getTime() + ((cfg && cfg.lunchLimitMin ? cfg.lunchLimitMin : 120) * 60 * 1000);
                  var now = Date.now();
                  var delta = limitMs - now;
                  if(delta > 0){
                    var mLeft = Math.ceil(delta/60000);
                    lunchDiv.textContent = 'No almoço — faltam ' + mLeft + ' min até o limite';
                  } else {
                    lunchDiv.textContent = 'Limite de almoço atingido';
                  }
                } else {
                  lunchDiv.textContent = '';
                }
              } else if(s && s.inicioAlm && s.fimAlm){
                var a = new Date(s.inicioAlm), b = new Date(s.fimAlm);
                if(!isNaN(a.getTime()) && !isNaN(b.getTime())){
                  var totalMin = Math.round((b - a)/60000);
                  lunchDiv.textContent = 'Almoço finalizado — duração: ' + totalMin + ' min';
                } else lunchDiv.textContent = '';
              } else {
                lunchDiv.textContent = '';
              }
            }

            renderHistory();
          }catch(e){ console.warn('render error', e); }
        }

        function renderHistory(){ try{
            historyEl.innerHTML = '';
            var keys = Object.keys(storage.dates || {}).filter(function(k){ return typeof k === 'string'; });
            keys.sort().reverse();
            keys = keys.slice(0, MAX_HISTORY_DAYS);
            for(var i=0;i<keys.length;i++){
              var dk = keys[i];
              var s = getStateFor(dk);
              var div = document.createElement('div');
              div.className = 'entry';
              div.innerHTML = '<div><div class="muted">'+dk+'</div><div>Entrada: '+(s.entrada?fmtTime(s.entrada):'--:--')+' — Saída: '+(s.saida?fmtTime(s.saida):'--:--')+'</div></div><div><button class="small" data-show="'+dk+'" type="button">Ver</button></div>';
              historyEl.appendChild(div);
            }
            logEl.innerHTML = '';
            var todayHist = (getStateFor(todayKey()) || {history: []}).history || [];
            for(var j=0;j<todayHist.length;j++){
              var h = todayHist[j];
              var d = document.createElement('div');
              d.className='entry';
              var timeStr = (h && h.time) ? (new Date(h.time)).toLocaleString() : '';
              d.innerHTML = '<div>' + (h.type || '') + ' — ' + timeStr + '</div><div><button class="small" data-remove="'+(h.time||'')+'" type="button">X</button></div>';
              logEl.appendChild(d);
            }
          }catch(e){ console.warn('renderHistory', e); } }

        // safe listener util
        function safeAddListener(id, evt, handler){
          try{
            var el = byId(id);
            if(el && typeof el.addEventListener === 'function'){
              el.addEventListener(evt, handler);
              return true;
            } else return false;
          }catch(e){ return false; }
        }

        // listeners (robustos)
        safeAddListener('btnEntrada','click', function(){ markEntrada(); });
        safeAddListener('btnInicioAlm','click', function(){ markInicioAlm(); });
        safeAddListener('btnFimAlm','click', function(){ markFimAlm(); });
        safeAddListener('btnSaida','click', function(){ markSaida(); });
        safeAddListener('btnReset','click', function(){ resetDia(); });

        safeAddListener('btnManual','click', function(){ var modal = byId('manualModal'); if(modal) modal.style.display = 'flex'; });
        safeAddListener('manualCancel','click', function(){ var modal = byId('manualModal'); if(modal) modal.style.display = 'none'; });
        safeAddListener('manualSave','click', function(){
          var tipoEl = byId('manualType'); var timeEl = byId('manualTime');
          var tipo = tipoEl? tipoEl.value : 'entrada'; var timeVal = timeEl? timeEl.value : '';
          var iso = null;
          if(timeVal){
            var parts = timeVal.split(':'); var d = new Date();
            d.setHours(parseInt(parts[0]||0,10), parseInt(parts[1]||0,10),0,0);
            iso = d.toISOString();
          }
          if(tipo === 'entrada') markEntrada(iso);
          else if(tipo === 'inicioAlm') markInicioAlm(iso);
          else if(tipo === 'fimAlm') markFimAlm(iso);
          else if(tipo === 'saida') markSaida(iso);
          var modal = byId('manualModal'); if(modal) modal.style.display = 'none';
        });

        safeAddListener('btnClearStorage2','click', function(){ if(confirm('Limpar todo o storage?')){ try{ localStorage.removeItem(KEY); localStorage.removeItem(CFG_KEY); storage = {dates:{}}; cfg = loadCfg(); ensureToday(); render(); alert('Storage limpo'); }catch(e){ reportError(e); } } });
        safeAddListener('btnTestTone','click', function(){ playTone(); setTimeout(function(){ stopTone(); }, 3000); });

        safeAddListener('btnRemoveEntrada','click', function(){ clearFieldToday('entrada'); });

        safeAddListener('btnLunchInc','click', function(){ var el = byId('cfgLunchLimit'); if(!el) return; el.value = Math.min(480, parseInt(el.value||120,10)+5); cfg.lunchLimitMin = parseInt(el.value,10); saveCfg(cfg); scheduleAll(); });
        safeAddListener('btnLunchDec','click', function(){ var el = byId('cfgLunchLimit'); if(!el) return; el.value = Math.max(15, parseInt(el.value||120,10)-5); cfg.lunchLimitMin = parseInt(el.value,10); saveCfg(cfg); scheduleAll(); });
        safeAddListener('cfgLunchLimit','change', function(e){ cfg.lunchLimitMin = parseInt(e.target.value||120,10); saveCfg(cfg); scheduleAll(); });
        safeAddListener('cfgMeeting','change', function(e){ cfg.meeting = e.target.value; saveCfg(cfg); scheduleAll(); });
        safeAddListener('btnAddMeeting','click', function(){ cfg.meeting = byId('cfgMeeting').value; saveCfg(cfg); scheduleAll(); alert('Lembrete salvo'); });

        safeAddListener('btnSaveCfg','click', function(){ cfg.lunchLimitMin = parseInt(byId('cfgLunchLimit').value||120,10); cfg.leaveWarnMin = parseInt(byId('cfgLeaveWarn').value||15,10); cfg.tone = byId('cfgTone').value; cfg.nag = byId('cfgNag').value; cfg.meeting = byId('cfgMeeting').value; saveCfg(cfg); setAudioSource(); scheduleAll(); alert('Configurações salvas'); });
        safeAddListener('btnResetCfg','click', function(){ if(confirm('Resetar configurações?')){ cfg = Object.assign({}, defaults.cfg); saveCfg(cfg); applyCfgToUI(); setAudioSource(); scheduleAll(); } });

        // install + notification
        var deferredPrompt = null;
        window.addEventListener('beforeinstallprompt', function(e){ try{ e.preventDefault(); deferredPrompt = e; var b = byId('btnInstall'); if(b) b.style.display = 'inline-block'; }catch(err){} });
        safeAddListener('btnInstall','click', function(){ try{ if(!deferredPrompt) return; deferredPrompt.prompt(); deferredPrompt.userChoice.then(function(choiceResult){ deferredPrompt = null; var b = byId('btnInstall'); if(b) b.style.display = 'none'; }); }catch(err){ reportError(err); } });
        safeAddListener('btnEnableNotif','click', function(){ try{ if('Notification' in window){ Notification.requestPermission().then(function(p){ alert('Permissão: ' + p); }); } else alert('Notifications API não disponível'); }catch(e){ reportError(e); } });

        // manifest and SW blob
        (function(){ try{
          var manifest = { name:'Ponto Reminder', short_name:'Ponto', start_url:'.', display:'standalone', background_color:'#07101a', theme_color:'#06d6a0', icons:[{src:'assets/icon-192.png',sizes:'192x192',type:'image/png'},{src:'assets/icon-512.png',sizes:'512x512',type:'image/png'}] };
          var manifestBlob = new Blob([JSON.stringify(manifest)], {type:'application/json'});
          var manifestURL = URL.createObjectURL(manifestBlob);
          var link = document.getElementById('appManifest'); if(link) link.setAttribute('href', manifestURL);
          if('serviceWorker' in navigator){ var swCode = "self.addEventListener('install',function(e){self.skipWaiting()});self.addEventListener('activate',function(e){self.clients.claim()});self.addEventListener('fetch',function(e){});"; var swBlob = new Blob([swCode], {type:'application/javascript'}); var swUrl = URL.createObjectURL(swBlob); navigator.serviceWorker.register(swUrl).catch(function(){}); }
        }catch(e){ console.warn('manifest error', e); } })();

        function applyCfgToUI(){ try{ byId('cfgLunchLimit').value = cfg.lunchLimitMin; byId('cfgLeaveWarn').value = cfg.leaveWarnMin; byId('cfgTone').value = cfg.tone || '01.mp3'; byId('cfgNag').value = cfg.nag || 'off'; byId('cfgMeeting').value = cfg.meeting || ''; }catch(e){} }

        applyCfgToUI(); render(); scheduleAll();

        function reportError(err){ try{ console.error(err); var box = byId('errorBox'); var msg = byId('errorMsg'); if(box){ box.style.display = 'block'; if(msg) msg.textContent = err && err.message ? err.message : String(err); } }catch(e){} }

        window.addEventListener('error', function(e){ reportError(e.error || e.message || 'Erro desconhecido'); });
        window.addEventListener('unhandledrejection', function(e){ reportError(e.reason || 'Promise rejeitada'); });

        var dateNow = byId('dateNow'); if(dateNow) dateNow.textContent = (new Date()).toLocaleDateString();

      }catch(e){ var box = document.getElementById('errorBox'); if(box){ box.style.display = 'block'; var msg = document.getElementById('errorMsg'); if(msg) msg.textContent = e.message || String(e); } console.error(e); }
    });
  </script>
</body>
</html>
